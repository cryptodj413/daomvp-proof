{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "Google Profile + Strict FHIR R4 EMR Bundle",
  "type": "object",
  "required": ["userId", "email", "timestamp", "profile", "metadata", "bundle"],
  "properties": {
    "userId": {
      "type": "string",
      "description": "Google user identifier"
    },
    "email": {
      "type": "string",
      "format": "email",
      "description": "User's email address"
    },
    "timestamp": {
      "type": "number",
      "description": "Timestamp of the data collection in milliseconds"
    },
    "profile": {
      "type": "object",
      "required": ["name"],
      "properties": {
        "name": { "type": "string" },
        "locale": { "type": "string" }
      }
    },
    "storage": {
      "type": "object",
      "properties": {
        "percentUsed": { "type": "number" }
      }
    },
    "metadata": {
      "type": "object",
      "required": ["source", "collectionDate", "dataType"],
      "properties": {
        "source": { "type": "string" },
        "collectionDate": { "type": "string", "format": "date-time" },
        "dataType": { "type": "string" }
      }
    },
    "bundle": {
      "type": "object",
      "required": ["resourceType", "type", "entry"],
      "properties": {
        "resourceType": { "type": "string", "enum": ["Bundle"] },
        "type": { "type": "string", "enum": ["transaction"] },
        "entry": {
          "type": "array",
          "items": {
            "type": "object",
            "required": ["fullUrl", "resource", "request"],
            "properties": {
              "fullUrl": { "type": "string" },
              "resource": {
                "type": "object",
                "oneOf": [
                  { "$ref": "#/definitions/patient" },
                  { "$ref": "#/definitions/encounter" },
                  { "$ref": "#/definitions/immunization" },
                  { "$ref": "#/definitions/diagnosticReport" },
                  { "$ref": "#/definitions/procedure" },
                  { "$ref": "#/definitions/device" },
                  { "$ref": "#/definitions/supplyDelivery" },
                  { "$ref": "#/definitions/explanationOfBenefit" }
                ]
              },
              "request": {
                "type": "object",
                "required": ["method", "url"],
                "properties": {
                  "method": { "type": "string", "enum": ["POST"] },
                  "url": { "type": "string" }
                }
              }
            }
          }
        }
      }
    }
  },

  "definitions": {
    "patient": {
      "type": "object",
      "required": ["resourceType", "id", "gender", "birthDate"],
      "properties": {
        "resourceType": { "type": "string", "enum": ["Patient"] },
        "id": { "type": "string" },
        "meta": {
          "type": "object",
          "properties": {
            "profile": {
              "type": "array",
              "items": { "type": "string" }
            }
          }
        },
        "text": {
          "type": "object",
          "properties": {
            "status": { "type": "string" },
            "div": { "type": "string" }
          }
        },
        "extension": {
          "type": "array",
          "items": { "type": "object" }
        },
        "identifier": {
          "type": "array",
          "items": { "type": "object" }
        },
        "name": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "use": { "type": "string" },
              "family": {
                "oneOf": [
                  { "type": "string" },
                  {
                    "type": "array",
                    "items": { "type": "string" }
                  }
                ]
              },
              "given": {
                "type": "array",
                "items": { "type": "string" }
              },
              "prefix": {
                "type": "array",
                "items": { "type": "string" }
              }
            }
          }
        },
        "telecom": {
          "type": "array",
          "items": { "type": "object" }
        },
        "gender": { "type": "string" },
        "birthDate": {
          "type": "string",
          "pattern": "^\\d{4}-\\d{2}-\\d{2}$"
        },
        "deceasedDateTime": { "type": "string", "format": "date-time" },
        "address": {
          "type": "array",
          "items": { "type": "object" }
        },
        "maritalStatus": { "type": "object" },
        "multipleBirthBoolean": { "type": "boolean" },
        "communication": {
          "type": "array",
          "items": { "type": "object" }
        }
      }
    },

    "encounter": {
      "type": "object",
      "required": ["resourceType", "status", "class", "subject", "period"],
      "properties": {
        "resourceType": { "type": "string", "enum": ["Encounter"] },
        "id": { "type": "string" },
        "status": { "type": "string" },
        "class": { "type": "object" },
        "type": {
          "type": "array",
          "items": { "type": "object" }
        },
        "subject": { "type": "object" },
        "participant": {
          "type": "array",
          "items": { "type": "object" }
        },
        "period": { "type": "object" },
        "reasonCode": {
          "type": "array",
          "items": { "type": "object" }
        }
      }
    },

    "immunization": {
      "type": "object",
      "required": [
        "resourceType",
        "status",
        "vaccineCode",
        "patient",
        "encounter",
        "occurrenceDateTime"
      ],
      "properties": {
        "resourceType": { "type": "string", "enum": ["Immunization"] },
        "id": { "type": "string" },
        "status": { "type": "string" },
        "vaccineCode": { "type": "object" },
        "patient": { "type": "object" },
        "encounter": { "type": "object" },
        "occurrenceDateTime": { "type": "string", "format": "date-time" },
        "location": { "type": "object" }
      }
    },

    "diagnosticReport": {
      "type": "object",
      "required": [
        "resourceType",
        "status",
        "code",
        "subject",
        "effectiveDateTime"
      ],
      "properties": {
        "resourceType": { "type": "string", "enum": ["DiagnosticReport"] },
        "id": { "type": "string" },
        "status": { "type": "string" },
        "code": { "type": "object" },
        "subject": { "type": "object" },
        "effectiveDateTime": { "type": "string", "format": "date-time" },
        "issued": { "type": "string", "format": "date-time" },
        "result": {
          "type": "array",
          "items": { "type": "object" }
        }
      }
    },

    "procedure": {
      "type": "object",
      "required": [
        "resourceType",
        "status",
        "code",
        "subject",
        "encounter",
        "performedPeriod"
      ],
      "properties": {
        "resourceType": { "type": "string", "enum": ["Procedure"] },
        "id": { "type": "string" },
        "status": { "type": "string" },
        "code": { "type": "object" },
        "subject": { "type": "object" },
        "encounter": { "type": "object" },
        "performedPeriod": { "type": "object" },
        "location": { "type": "object" }
      }
    },

    "device": {
      "type": "object",
      "required": ["resourceType", "status", "serialNumber", "type", "patient"],
      "properties": {
        "resourceType": { "type": "string", "enum": ["Device"] },
        "id": { "type": "string" },
        "status": { "type": "string" },
        "udiCarrier": {
          "type": "array",
          "items": { "type": "object" }
        },
        "serialNumber": { "type": "string" },
        "deviceName": {
          "type": "array",
          "items": { "type": "object" }
        },
        "type": { "type": "object" },
        "patient": { "type": "object" }
      }
    },

    "supplyDelivery": {
      "type": "object",
      "required": [
        "resourceType",
        "status",
        "patient",
        "type",
        "occurrenceDateTime"
      ],
      "properties": {
        "resourceType": { "type": "string", "enum": ["SupplyDelivery"] },
        "id": { "type": "string" },
        "status": { "type": "string" },
        "patient": { "type": "object" },
        "type": { "type": "object" },
        "suppliedItem": {
          "type": "array",
          "items": { "type": "object" }
        },
        "occurrenceDateTime": { "type": "string", "format": "date-time" }
      }
    },

    "explanationOfBenefit": {
      "type": "object",
      "required": [
        "resourceType",
        "status",
        "type",
        "use",
        "patient",
        "billablePeriod",
        "created",
        "insurer",
        "provider"
      ],
      "properties": {
        "resourceType": {
          "type": "string",
          "enum": ["ExplanationOfBenefit"]
        },
        "id": { "type": "string" },
        "status": { "type": "string" },
        "type": { "type": "object" },
        "use": { "type": "string" },
        "patient": { "type": "object" },
        "billablePeriod": { "type": "object" },
        "created": { "type": "string", "format": "date-time" },
        "insurer": { "type": "object" },
        "provider": { "type": "object" },
        "insurance": {
          "type": "array",
          "items": { "type": "object" }
        },
        "item": {
          "type": "array",
          "items": { "type": "object" }
        },
        "total": {
          "type": "array",
          "items": { "type": "object" }
        }
      }
    }
  }
}
